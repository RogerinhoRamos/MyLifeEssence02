<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador CNC Profissional v3.0 | RR Rogerinho Ramos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; width: 100%; scroll-behavior: smooth; }
        :root {
            --primary: #00d4ff; --secondary: #ff6b35; --purple: #8b5cf6; --green: #10b981;
            --gold: #fbbf24; --accent: #4ecdc4; --dark: #0a0a0a; --gray: #1a1a1a; --light-gray: #2a2a2a;
            --white: #ffffff; --text-light: #b0b0b0;
        }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, var(--dark) 0%, var(--gray) 100%); color: var(--white); overflow-x: hidden; overflow-y: auto; width: 100%; max-width: 100vw; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--gray); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(45deg, var(--primary), var(--secondary)); border-radius: 4px; }
        .header { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 1rem 2%; position: sticky; top: 0; z-index: 1000; width: 100%; max-width: 100vw; overflow-x: hidden; }
        .header-content { max-width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo-rr { font-size: 1.5rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-nome { font-size: 1.3rem; font-weight: 500; font-family: 'Brush Script MT', cursive; background: linear-gradient(45deg, var(--primary), var(--secondary), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-title { flex: 1; text-align: center; font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .back-link { color: var(--primary); text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 2px solid rgba(0, 212, 255, 0.3); border-radius: 50px; transition: all 0.3s ease; }
        .back-link:hover { background: rgba(0, 212, 255, 0.1); transform: translateX(-3px); }
        .main-container { display: flex; height: calc(100vh - 80px); overflow: hidden; width: 100%; max-width: 100vw; }
        .editor-section { width: 50%; display: flex; flex-direction: column; border-right: 1px solid rgba(255, 255, 255, 0.1); overflow: hidden; }
        .editor-toolbar { background: rgba(10, 10, 10, 0.95); padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; gap: 1rem; }
        .program-name-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 0.6rem; color: var(--white); font-size: 1rem; font-weight: 600; width: 100%; }
        .program-name-input:focus { outline: none; border-color: var(--primary); }
        .toolbar-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .numbering-controls { display: flex; gap: 0.5rem; align-items: center; background: rgba(139, 92, 246, 0.1); padding: 0.5rem; border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.3); }
        .increment-input { width: 60px; padding: 0.3rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 5px; color: var(--white); font-size: 0.8rem; text-align: center; }
        .increment-input:focus { outline: none; border-color: var(--purple); }
        .dialect-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.6rem 1rem; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.4rem; white-space: nowrap; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: var(--white); }
        .btn-secondary { background: transparent; color: var(--white); border: 2px solid rgba(255, 255, 255, 0.2); }
        .btn-dialect { padding: 0.5rem 1rem; background: transparent; color: var(--white); border: 2px solid rgba(255, 255, 255, 0.2); font-size: 0.8rem; }
        .btn-dialect.active { background: var(--primary); border-color: var(--primary); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3); }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.75rem; }
        .editor-area { flex: 1; display: flex; overflow: hidden; }
        .line-numbers { background: var(--gray); padding: 1rem 0.8rem; text-align: right; color: var(--text-light); font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; overflow-y: auto; user-select: none; }
        .line-number { padding: 0 0.5rem; }
        .line-number.active { background: rgba(0, 212, 255, 0.3); color: var(--white); font-weight: bold; }
        .code-editor-wrapper { flex: 1; position: relative; overflow: hidden; }
        .code-editor { width: 100%; height: 100%; background: var(--dark); color: #e0e0e0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; padding: 1rem; border: none; outline: none; resize: none; overflow-y: auto; tab-size: 4; position: absolute; top: 0; left: 0; }
        .code-highlight { width: 100%; height: 100%; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; padding: 1rem; overflow-y: auto; pointer-events: none; white-space: pre-wrap; word-wrap: break-word; }
        .code-editor::placeholder { color: var(--text-light); }
        .hl-g00 { color: #ff4444; font-weight: bold; } .hl-g01 { color: #44ff44; font-weight: bold; }
        .hl-g02 { color: #00bfff; font-weight: bold; } .hl-g33 { color: #ff6b35; font-weight: bold; }
        .hl-g76 { color: #ff6b35; font-weight: bold; } .hl-g-other { color: #a78bfa; font-weight: bold; }
        .hl-m { color: #fbbf24; font-weight: bold; } .hl-number { color: #60a5fa; }
        .hl-comment { color: #6b7280; font-style: italic; } .hl-letter { color: #f472b6; }
        .editor-controls { background: rgba(10, 10, 10, 0.95); padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap; }
        .viewer-section { width: 50%; display: flex; flex-direction: column; overflow: hidden; }
        .viewer-header { background: rgba(10, 10, 10, 0.95); padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .viewer-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 0.8rem; }
        .legend { display: flex; gap: 1.5rem; font-size: 0.8rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; }
        .legend-line { width: 20px; height: 3px; border-radius: 2px; }
        .canvas-wrapper { flex: 1; position: relative; background: #0f1419; min-height: 400px; width: 100%; overflow: hidden; }
        #canvas3d { width: 100%; height: 100%; min-height: 400px; display: block; cursor: move; }
        .camera-controls, .view-controls, .mini-controls, .plane-selector, .compensation-indicator, .info-overlay { position: absolute; z-index: 10; }
        .camera-controls { top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .control-btn { width: 38px; height: 38px; background: rgba(10, 10, 10, 0.85); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: var(--white); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 0.95rem; }
        .control-btn:hover { background: rgba(0, 212, 255, 0.3); border-color: var(--primary); transform: scale(1.1); }
        .control-btn.active { background: rgba(0, 212, 255, 0.5); border-color: var(--primary); }
        .view-controls { top: 1rem; left: 1rem; display: flex; flex-direction: column; gap: 0.4rem; }
        .mini-controls { bottom: 1rem; right: 1rem; display: flex; gap: 0.5rem; background: rgba(10, 10, 10, 0.85); padding: 0.5rem; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .mini-btn { width: 38px; height: 38px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--white); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 0.95rem; }
        .mini-btn:hover { background: rgba(0, 212, 255, 0.3); transform: scale(1.1); }
        .mini-btn.play { background: linear-gradient(45deg, var(--primary), var(--secondary)); }
        .info-overlay { bottom: 60px; left: 1rem; background: rgba(10, 10, 10, 0.9); padding: 0.7rem; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.7rem; max-width: 180px; z-index: 5; }
        .info-title { font-weight: 600; color: var(--primary); margin-bottom: 0.4rem; font-size: 0.75rem; }
        .stats-bar { background: rgba(10, 10, 10, 0.95); padding: 0.6rem 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 0.5rem; }
        .stat-box { text-align: center; } .stat-label { font-size: 0.7rem; color: var(--text-light); margin-bottom: 0.2rem; } .stat-value { font-size: 1rem; font-weight: bold; }
        .plane-selector { top: 1rem; left: 50%; transform: translateX(-50%); display: flex; gap: 0.5rem; background: rgba(10, 10, 10, 0.9); padding: 0.5rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 20; }
        .plane-btn { padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--white); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.4rem; }
        .plane-btn:hover { background: rgba(0, 212, 255, 0.2); border-color: var(--primary); transform: translateY(-2px); }
        .plane-btn.active { background: linear-gradient(45deg, var(--primary), var(--secondary)); border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 212, 255, 0.5); }
        .plane-icon { font-size: 1rem; }
        .compensation-indicator { top: 5rem; left: 50%; transform: translateX(-50%); background: rgba(139, 92, 246, 0.9); padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; font-size: 0.85rem; display: none; }
        .compensation-indicator.active { display: block; }

        /* Responsivo (igual ao seu) */
        @media (max-width: 1024px) { .main-container{flex-direction:column;height:auto;} .editor-section{width:100%;height:50vh;min-height:400px;max-height:50vh;border-right:none;} .viewer-section{width:100%;min-height:500px;} .canvas-wrapper{min-height:400px;height:400px;} #canvas3d{width:100%!important;height:100%!important;max-width:100vw;} .stats-bar{grid-template-columns:repeat(3,1fr);} }
        @media (max-width: 768px) { .editor-section{height:45vh;min-height:350px;max-height:45vh;} .viewer-section{min-height:450px;} .canvas-wrapper{min-height:350px;height:350px;} }
        @media (max-width: 480px) { .editor-section{height:40vh;min-height:300px;max-height:40vh;} .canvas-wrapper{min-height:300px;height:300px;} .viewer-section{min-height:400px;} }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <a href="index.html" class="logo">
            <span class="logo-rr">RR</span>
            <span class="logo-nome">Rogerinho Ramos</span>
        </a>
        <div class="header-title"><i class="fas fa-microchip"></i> Simulador CNC Profissional v3.0</div>
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Voltar</a>
    </div>
</header>

<div class="main-container">
    <div class="editor-section">
        <div class="editor-toolbar">
            <input type="text" id="programName" class="program-name-input" value="Novo Programa" placeholder="Nome do programa">
            <div class="toolbar-buttons">
                <button class="btn btn-primary" onclick="newProgram()"><i class="fas fa-file"></i> Novo</button>
                <button class="btn btn-secondary" onclick="openExamples()"><i class="fas fa-folder-open"></i> Exemplos</button>
                <button class="btn btn-secondary" onclick="openCodeRef()"><i class="fas fa-book"></i> Códigos</button>
                <button class="btn btn-secondary" onclick="openVariables()"><i class="fas fa-hashtag"></i> Variáveis</button>
                <button class="btn btn-secondary" onclick="downloadProgram()"><i class="fas fa-save"></i> Salvar</button>
                <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                    <i class="fas fa-upload"></i> Abrir
                    <input type="file" accept=".nc,.txt,.gcode" onchange="uploadFile(event)" style="display: none;">
                </label>
            </div>

            <div class="numbering-controls">
                <span style="color: var(--purple); font-size: 0.8rem; font-weight: 600;"><i class="fas fa-list-ol"></i> Numeração:</span>
                <input type="number" id="incrementInput" class="increment-input" value="10" min="1" max="1000">
                <button class="btn btn-secondary btn-small" onclick="addLineNumbers()"><i class="fas fa-plus"></i> Add</button>
                <button class="btn btn-secondary btn-small" onclick="removeLineNumbers()"><i class="fas fa-minus"></i> Remove</button>
            </div>

            <div class="dialect-buttons">
                <button class="btn-dialect active" onclick="setDialect('FANUC')" data-dialect="FANUC">FANUC</button>
                <button class="btn-dialect" onclick="setDialect('SIEMENS')" data-dialect="SIEMENS">Siemens</button>
                <button class="btn-dialect" onclick="setDialect('ISO')" data-dialect="ISO">ISO</button>
            </div>
        </div>

        <div class="editor-area">
            <div class="line-numbers" id="lineNumbers"></div>
            <div class="code-editor-wrapper">
                <div class="code-highlight" id="codeHighlight"></div>
                <textarea class="code-editor" id="codeEditor" placeholder="Cole seu código G aqui..." spellcheck="false"></textarea>
            </div>
        </div>

        <div class="editor-controls">
            <button class="btn btn-primary" onclick="runSimulation()" id="runBtn"><i class="fas fa-play"></i> Executar</button>
            <button class="btn btn-secondary" onclick="pauseSimulation()" id="pauseBtn" style="display: none;"><i class="fas fa-pause"></i> Pausar</button>
            <button class="btn btn-secondary" onclick="stepSimulation()"><i class="fas fa-step-forward"></i> Passo</button>
            <button class="btn btn-secondary" onclick="resetSimulation()"><i class="fas fa-redo"></i> Reset</button>
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                <i class="fas fa-tachometer-alt" style="color: var(--primary);"></i>
                <input type="range" min="10" max="500" value="100" id="speedSlider" oninput="updateSpeed(this.value)" style="width: 100px; accent-color: var(--primary);">
                <span id="speedDisplay" style="min-width: 60px; color: var(--text-light); font-size: 0.85rem;">100ms</span>
            </div>
        </div>
    </div>

    <div class="viewer-section">
        <div class="viewer-header">
            <div class="viewer-title"><i class="fas fa-cube"></i> Visualização 3D <span id="dialectDisplay">FANUC</span></div>
            <div class="legend">
                <div class="legend-item"><div class="legend-line" style="background: #ff3333; box-shadow: 0 0 8px #ff3333;"></div><span>G00 Rápido</span></div>
                <div class="legend-item"><div class="legend-line" style="background: #00ff00; box-shadow: 0 0 8px #00ff00;"></div><span>G01 Usinagem</span></div>
                <div class="legend-item"><div class="legend-line" style="background: #00ffff; box-shadow: 0 0 8px #00ffff;"></div><span>G02/G03 Arcos</span></div>
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="canvas3d"></canvas>

            <div class="plane-selector">
                <button class="plane-btn active" onclick="setPlane(17)" id="btnG17" title="Plano XY - Fresadora (Vista de Cima)"><span class="plane-icon">📐</span><span>G17 XY</span></button>
                <button class="plane-btn" onclick="setPlane(18)" id="btnG18" title="Plano ZX - Torno (Vista Lateral)"><span class="plane-icon">⚙️</span><span>G18 ZX</span></button>
            </div>

            <div class="compensation-indicator" id="compensationIndicator">G40</div>

            <div class="info-overlay">
                <div class="info-title">💡 Controles:</div>
                <div style="line-height: 1.6; font-size: 0.7rem;">
                    🖱️ Girar: Arrastar<br>🔍 Zoom: Scroll<br>📏 <span id="distanceDisplay">120</span>mm<br>
                    <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 0.3rem 0;">
                    <strong>Atalhos:</strong><br>⌨️ 1 = G17 XY<br>⌨️ 2 = G18 ZX
                </div>
            </div>

            <div class="view-controls">
                <button class="control-btn active" onclick="toggleTool()" id="btnTool" title="Mostrar/Ocultar Ferramenta"><i class="fas fa-wrench"></i></button>
                <button class="control-btn active" onclick="toggleGrid()" id="btnGrid" title="Mostrar/Ocultar Grade"><i class="fas fa-grip-lines"></i></button>
                <button class="control-btn active" onclick="toggleAxes()" id="btnAxes" title="Mostrar/Ocultar Eixos"><i class="fas fa-arrows-alt"></i></button>
                <button class="control-btn active" onclick="toggleWorkpiece()" id="btnWorkpiece" title="Mostrar/Ocultar Peça"><i class="fas fa-cube"></i></button>
                <button class="control-btn active" onclick="toggleTable()" id="btnTable" title="Mostrar/Ocultar Mesa"><i class="fas fa-square"></i></button>
                <button class="control-btn" onclick="toggleDarkMode()" id="btnDarkMode" title="Alternar Tema Escuro/Claro"><i class="fas fa-moon"></i></button>
            </div>

            <div class="camera-controls">
                <button class="control-btn" onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
                <button class="control-btn" onclick="resetCamera()" title="Reset"><i class="fas fa-sync-alt"></i></button>
            </div>

            <div class="mini-controls">
                <button class="mini-btn play" onclick="runSimulation()" title="Executar"><i class="fas fa-play"></i></button>
                <button class="mini-btn" onclick="stepSimulation()" title="Passo"><i class="fas fa-step-forward"></i></button>
                <button class="mini-btn" onclick="resetSimulation()" title="Reset"><i class="fas fa-redo"></i></button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-box"><div class="stat-label">X</div><div class="stat-value" style="color: var(--primary);" id="posX">0.00</div></div>
            <div class="stat-box"><div class="stat-label">Y</div><div class="stat-value" style="color: var(--green);" id="posY">0.00</div></div>
            <div class="stat-box"><div class="stat-label">Z</div><div class="stat-value" style="color: var(--purple);" id="posZ">0.00</div></div>
            <div class="stat-box"><div class="stat-label">RPM</div><div class="stat-value" style="color: var(--gold);" id="spindle">0</div></div>
            <div class="stat-box"><div class="stat-label">Feed</div><div class="stat-value" style="color: var(--accent);" id="feedRate">0</div></div>
            <div class="stat-box"><div class="stat-label">Linha</div><div class="stat-value" style="color: var(--white);" id="currentLine">0</div></div>
        </div>
    </div>
</div>

<div class="modal" id="examplesModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">📚 Exemplos</div>
            <button class="close-btn" onclick="closeModal('examplesModal')">&times;</button>
        </div>
        <div id="examplesContent"></div>
    </div>
</div>

<div class="modal" id="codeRefModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">📖 Referência</div>
            <button class="close-btn" onclick="closeModal('codeRefModal')">&times;</button>
        </div>
        <div id="codeRefContent"></div>
    </div>
</div>

<div class="modal" id="variablesModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">🔢 Variáveis</div>
            <button class="close-btn" onclick="closeModal('variablesModal')">&times;</button>
        </div>
        <div id="variablesContent">
            <p style="text-align: center; color: var(--text-light); padding: 2rem;">
                Execute um programa paramétrico para ver variáveis.
            </p>
        </div>
    </div>
</div>

<script>
/* =======================
   ESTADO & CENA 3D
======================= */
let currentDialect = 'FANUC';
let scene, camera, renderer;
let cameraDistance = 120;
let cameraAngle = { theta: 45, phi: 45 };
let isDragging = false;
let lastMousePos = { x: 0, y: 0 };
let isRunning = false;
let currentLineIndex = 0;
let toolPathLines = [];
let variables = {};
let simulationSpeed = 100;
let isDarkMode = true;
let labelIndex = {};     // <== índice de labels Nxxxx
const flowStack = [];    // <== pilha WHILE

let sceneObjects = { tool: null, grid: null, axes: null, workpiece: null, table: null };

const machineState = {
  position: { x: 0, y: 0, z: 0 },
  modalG: { motion: 0, plane: 17, distance: 90, compensation: 40, cycle: 0 },
  feedRate: 0, spindleSpeed: 0, toolRadius: 5,
  cycleParams: { R: 0, Z: 0, Q: 0, P: 0, F: 0 }
};

/* =======================
   EXEMPLOS
======================= */
const examples = {
  FANUC: [
    { name: 'Quadrado', category: 'Básico', description: '50x50mm',
      code: '; Quadrado 50x50mm\nG54 G90 G21 G17\nM03 S1500\n\nG00 X-25 Y-25\nG00 Z5\nG01 Z-3 F100\nG01 X25 Y-25 F200\nG01 X25 Y25\nG01 X-25 Y25\nG01 X-25 Y-25\nG00 Z5\nG00 X0 Y0\n\nM05\nM30' },
    { name: 'Círculo G02', category: 'Básico', description: 'Círculo R25mm horário',
      code: '; Círculo R25mm\nG54 G90 G21 G17\nM03 S1800\n\nG00 X25 Y0\nG00 Z5\nG01 Z-2 F100\nG02 X25 Y0 I-25 J0 F150\nG00 Z5\nG00 X0 Y0\n\nM05\nM30' },
    { name: 'Círculo G03', category: 'Básico', description: 'Círculo R20mm anti-horário',
      code: '; Círculo Anti-horário\nG54 G90 G21 G17\nM03 S2000\n\nG00 X20 Y0\nG00 Z5\nG01 Z-2 F100\nG03 X20 Y0 I-20 J0 F150\nG00 Z5\nG00 X0 Y0\n\nM05\nM30' },
    { name: 'Furos em Círculo', category: 'Furação', description: '6 furos Ø8mm em Ø70mm',
      code: '; 6 Furos em Círculo\n; Ø8mm em Ø70mm (PCD)\nG54 G90 G21 G17\nM03 S2000\nG00 Z5\n\n; Furo 1 - 0°\nG00 X35 Y0\nG83 Z-15 R2 Q3 F80\n\n; Furo 2 - 60°\nG00 X17.5 Y30.31\nG83 Z-15 R2 Q3 F80\n\n; Furo 3 - 120°\nG00 X-17.5 Y30.31\nG83 Z-15 R2 Q3 F80\n\n; Furo 4 - 180°\nG00 X-35 Y0\nG83 Z-15 R2 Q3 F80\n\n; Furo 5 - 240°\nG00 X-17.5 Y-30.31\nG83 Z-15 R2 Q3 F80\n\n; Furo 6 - 300°\nG00 X17.5 Y-30.31\nG83 Z-15 R2 Q3 F80\n\nG80\nG00 Z50\nM05\nM30' },
    { name: 'Rosca Helicoidal (MODO Z)', category: 'Paramétrico', description: '0=Descer / 1=Subir (Fanuc Macro B)',
      code:
`% 
; Rosca Helicoidal Paramétrica (Fanuc)
G54 G90 G21 G17
M03 S1800

#31=84.0   (DIAM FURO)
#2 =1.783  (ANG ROSCA)
#3 =3.175  (PASSO)
#4 =0.000  (Z TOPO)
#5 =-20.0  (Z FUNDO)
#6 =0      (XC)
#7 =0      (YC)
#8 =0      (ANG INI)
#9 =1      (RESOL ANG GRAU)
#10=20     (D FERR)
#11=400    (F HELICOIDE)
#12=0      (ROSCA DIR=0/ESQ=1)
#13=22     (22=ROSCA INTERNA)
#14=1      (MODO Z: 0=DESCER 1=SUBIR)

#21=#4-#5
#133=[[[#21*TAN[#2]]*2]+#31]
#134=[[#3*0.65]*2]+#133
#1=#134
#20=[#1-#10]/2
#22=[#9*#3]/360
#23=TAN[#2]*#21
#24=TAN[#2]*#3
#25=#9*#24/360
#26=0
#27=#22*#26
#28=#20-#23
#29=#8+[#21*360/#3]
#30=1    (direita)

; posiciona no raio inicial
G00 X[#6+[#20*COS[#8]]] Y[#7+[#20*SIN[#8]]]

IF[#14EQ0]GOTO1000
IF[#14EQ1]GOTO2000

N1000 (DESCER)
G00 Z[#4+2]
G01 Z#4 F#11
WHILE [#27 LT #21] DO1
  G01 X[#6+[[#20+[#30*#25*#26]]*COS[#8]]]
      Y[#7+[[#20+[#30*#25*#26]]*SIN[#8]]]
      Z[#4-#27]
  #26=[#26-[#30*#9]]
  #8=[#8-[#30*#9]]
  #27=[#27+#22]
END1
GOTO9000

N2000 (SUBIR)
G00 Z[#5+2]
G01 Z#5 F[#11*0.6]
#26=0
#27=#22*#26
WHILE [#27 LT #21] DO1
  G01 X[#6+[[#20+[#30*#25*#26]]*COS[#8]]]
      Y[#7+[[#20+[#30*#25*#26]]*SIN[#8]]]
      Z[#5+#27]
  #26=[#26-[#30*#9]]
  #8=[#8-[#30*#9]]
  #27=[#27+#22]
END1

N9000
G00 Z#4+2
M05
M30
%` }
  ],
  SIEMENS: [
    { name: 'Retângulo', category: 'Básico', description: '60x40mm',
      code: '; Retângulo 60x40mm\nG54 G90 G71\nM3 S1500\n\nG0 X-30 Y-20 Z5\nG1 Z-2 F100\nG1 X30 F200\nG1 Y20\nG1 X-30\nG1 Y-20\nG0 Z5\n\nM5\nM30' },
    { name: 'Círculo', category: 'Básico', description: 'R15mm',
      code: '; Círculo Siemens\nG54 G90 G71\nM3 S1800\n\nG0 X15 Y0 Z5\nG1 Z-2 F100\nG2 X15 Y0 I-15 J0 F150\nG0 Z5\n\nM5\nM30' },
    { name: 'Rosca Helicoidal (MODO Z)', category: 'Paramétrico', description: '0=Descer / 1=Subir (Sinumerik ISO)',
      code:
`; Rosca Helicoidal Paramétrica (Siemens ISO)
G54 G90 G71 G17
M3 S1800

R31 = 84.0   ; DIAM FURO
R2  = 1.783  ; ANG ROSCA
R3  = 3.175  ; PASSO
R4  = 0.000  ; Z TOPO
R5  = -20.0  ; Z FUNDO
R6  = 0      ; XC
R7  = 0      ; YC
R8  = 0      ; ANG INI (graus)
R9  = 1      ; RESOL ANG
R10 = 20     ; D FERR
R11 = 400    ; F HELICOIDE
R12 = 0      ; ROSCA DIR=0 / ESQ=1
R13 = 22     ; 22=ROSCA INTERNA
R14 = 1      ; MODO Z: 0=DESCER 1=SUBIR

R21 = R4 - R5
R33 = (((R21*TAN(R2))*2)+R31)
R34 = ((R3*0.65)*2)+R33
R1  = R34
R20 = (R1 - R10)/2
R22 = R9 * R3 / 360
R23 = TAN(R2) * R21
R24 = TAN(R2) * R3
R25 = R9 * R24 / 360
R26 = 0
R27 = R22 * R26
R28 = R20 - R23
R29 = R8 + (R21*360 / R3)
R30 = 1  ; direita

; posiciona
G0 X( R6 + (R20*COS(R8)) )  Y( R7 + (R20*SIN(R8)) )

; MODO
IF (R14==0) GOTO N1000
IF (R14==1) GOTO N2000

N1000 ; DESCER
G0 Z(R4+2)
G1 Z(R4) F(R11)
WHILE (R27 < R21) DO
  G1 X( R6 + ( (R20+(R30*R25*R26))*COS(R8) ) )
     Y( R7 + ( (R20+(R30*R25*R26))*SIN(R8) ) )
     Z( R4 - R27 )
  R26 = R26 - (R30*R9)
  R8  = R8  - (R30*R9)
  R27 = R27 + R22
ENDWHILE
GOTO N9000

N2000 ; SUBIR
G0 Z(R5+2)
G1 Z(R5) F(R11*0.6)
R26 = 0
R27 = R22 * R26
WHILE (R27 < R21) DO
  G1 X( R6 + ( (R20+(R30*R25*R26))*COS(R8) ) )
     Y( R7 + ( (R20+(R30*R25*R26))*SIN(R8) ) )
     Z( R5 + R27 )
  R26 = R26 - (R30*R9)
  R8  = R8  - (R30*R9)
  R27 = R27 + R22
ENDWHILE

N9000
G0 Z(R4+2)
M5
M30` }
  ],
  ISO: [
    { name: 'Hexágono', category: 'Básico', description: '6 lados',
      code: '; Hexágono\nG54 G90 G21\nM03 S1500\n\nG00 X20 Y0 Z5\nG01 Z-2 F100\nG01 X10 Y17.3 F180\nG01 X-10 Y17.3\nG01 X-20 Y0\nG01 X-10 Y-17.3\nG01 X10 Y-17.3\nG01 X20 Y0\nG00 Z5\n\nM05\nM30' }
  ]
};

/* =======================
   BOOT
======================= */
document.addEventListener('DOMContentLoaded', () => {
  init3D();
  loadExample('FANUC', 0);
  updateLineNumbers();
  updateSyntaxHighlighting();
  setTimeout(onResize, 100);

  const editor = document.getElementById('codeEditor');
  editor.addEventListener('input', () => { updateLineNumbers(); updateSyntaxHighlighting(); });
  editor.addEventListener('scroll', () => {
    document.getElementById('lineNumbers').scrollTop = editor.scrollTop;
    document.getElementById('codeHighlight').scrollTop = editor.scrollTop;
  });
});

/* =======================
   3D / CAMERA / UI
======================= */
function init3D(){
  const canvas = document.getElementById('canvas3d');
  const width = canvas.clientWidth, height = canvas.clientHeight;
  scene = new THREE.Scene(); scene.background = new THREE.Color(0x0f1419);
  camera = new THREE.PerspectiveCamera(75, width/height, 0.1, 1000); updateCameraPosition();
  renderer = new THREE.WebGLRenderer({ canvas, antialias:true }); renderer.setSize(width,height); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); scene.add(ambientLight);
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6); directionalLight.position.set(50,50,50); scene.add(directionalLight);
  const gridHelper = new THREE.GridHelper(200, 20, 0x00d4ff, 0x334455); scene.add(gridHelper); sceneObjects.grid = gridHelper;
  const axesHelper = new THREE.AxesHelper(60); scene.add(axesHelper); sceneObjects.axes = axesHelper;
  const table = new THREE.Mesh(new THREE.BoxGeometry(100,2,100), new THREE.MeshPhongMaterial({ color:0x1a2332, transparent:true, opacity:0.8 })); table.position.y=-1; scene.add(table); sceneObjects.table=table;
  const workpiece = new THREE.Mesh(new THREE.BoxGeometry(80,20,80), new THREE.MeshPhongMaterial({ color:0x334455, transparent:true, opacity:0.25, side:THREE.DoubleSide })); workpiece.position.y=10; scene.add(workpiece); sceneObjects.workpiece=workpiece;
  const tool = new THREE.Mesh(new THREE.ConeGeometry(2,15,8), new THREE.MeshPhongMaterial({ color:0xfbbf24, emissive:0xfbbf24, emissiveIntensity:0.3 })); tool.position.set(0,30,0); tool.rotation.x=Math.PI; tool.name='tool'; scene.add(tool); sceneObjects.tool=tool;

  canvas.addEventListener('mousedown', onMouseDown);
  canvas.addEventListener('mousemove', onMouseMove);
  canvas.addEventListener('mouseup', onMouseUp);
  canvas.addEventListener('mouseleave', onMouseUp);
  canvas.addEventListener('wheel', onWheel);
  window.addEventListener('resize', onResize);
  window.addEventListener('orientationchange', ()=> setTimeout(onResize,100));
  animate();
}
function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
function updateCameraPosition(){ const th=cameraAngle.theta*Math.PI/180, ph=cameraAngle.phi*Math.PI/180; camera.position.x=cameraDistance*Math.sin(ph)*Math.cos(th); camera.position.y=cameraDistance*Math.cos(ph); camera.position.z=cameraDistance*Math.sin(ph)*Math.sin(th); camera.lookAt(0,0,0); document.getElementById('distanceDisplay').textContent=cameraDistance.toFixed(0); }
function onMouseDown(e){ if(e.button===0){ isDragging=true; lastMousePos={x:e.clientX,y:e.clientY}; } }
function onMouseMove(e){ if(!isDragging) return; const dx=e.clientX-lastMousePos.x, dy=e.clientY-lastMousePos.y; cameraAngle.theta+=dx*0.5; cameraAngle.phi=Math.max(5, Math.min(175, cameraAngle.phi+dy*0.5)); updateCameraPosition(); lastMousePos={x:e.clientX,y:e.clientY}; }
function onMouseUp(){ isDragging=false; }
function onWheel(e){ e.preventDefault(); const delta=e.deltaY>0?10:-10; cameraDistance=Math.max(30, Math.min(300, cameraDistance+delta)); updateCameraPosition(); }
function onResize(){ const canvas = document.getElementById('canvas3d'); const width=canvas.clientWidth, height=canvas.clientHeight; camera.aspect=width/height; camera.updateProjectionMatrix(); renderer.setSize(width,height); }
function zoomIn(){ cameraDistance=Math.max(30, cameraDistance-20); updateCameraPosition(); }
function zoomOut(){ cameraDistance=Math.min(300, cameraDistance+20); updateCameraPosition(); }
function resetCamera(){ cameraDistance=120; cameraAngle={theta:45,phi:45}; updateCameraPosition(); }
function setPlane(plane){ machineState.modalG.plane=plane; document.querySelectorAll('.plane-btn').forEach(btn=>btn.classList.remove('active')); if(plane===17){ document.getElementById('btnG17').classList.add('active'); animateCamera({theta:0,phi:10},150); } else if(plane===18){ document.getElementById('btnG18').classList.add('active'); animateCamera({theta:90,phi:90},150); } }
function animateCamera(targetAngle, targetDistance, duration=500){ const startAngle={...cameraAngle}; const startDistance=cameraDistance; const startTime=Date.now(); function anim(){ const t=(Date.now()-startTime)/duration; const p=Math.min(t,1); const e=p<0.5?2*p*p:1-(( -2*p+2)**2)/2; cameraAngle.theta=startAngle.theta+(targetAngle.theta-startAngle.theta)*e; cameraAngle.phi=startAngle.phi+(targetAngle.phi-startAngle.phi)*e; cameraDistance=startDistance+( (targetDistance??cameraDistance)-startDistance)*e; updateCameraPosition(); if(p<1) requestAnimationFrame(anim); } anim(); }
function toggleTool(){ if(sceneObjects.tool){ sceneObjects.tool.visible=!sceneObjects.tool.visible; document.getElementById('btnTool').classList.toggle('active'); } }
function toggleGrid(){ if(sceneObjects.grid){ sceneObjects.grid.visible=!sceneObjects.grid.visible; document.getElementById('btnGrid').classList.toggle('active'); } }
function toggleAxes(){ if(sceneObjects.axes){ sceneObjects.axes.visible=!sceneObjects.axes.visible; document.getElementById('btnAxes').classList.toggle('active'); } }
function toggleWorkpiece(){ if(sceneObjects.workpiece){ sceneObjects.workpiece.visible=!sceneObjects.workpiece.visible; document.getElementById('btnWorkpiece').classList.toggle('active'); } }
function toggleTable(){ if(sceneObjects.table){ sceneObjects.table.visible=!sceneObjects.table.visible; document.getElementById('btnTable').classList.toggle('active'); } }
function toggleDarkMode(){ isDarkMode=!isDarkMode; const btn=document.getElementById('btnDarkMode'); if(isDarkMode){ scene.background=new THREE.Color(0x0f1419); btn.innerHTML='<i class="fas fa-moon"></i>'; btn.classList.remove('active'); if(sceneObjects.workpiece){ sceneObjects.workpiece.material.color.setHex(0x334455); sceneObjects.workpiece.material.opacity=0.25;} if(sceneObjects.table){ sceneObjects.table.material.color.setHex(0x1a2332);} if(sceneObjects.grid){ sceneObjects.grid.material.color.setHex(0x00d4ff);} } else { scene.background=new THREE.Color(0xe8eef5); btn.innerHTML='<i class="fas fa-sun"></i>'; btn.classList.add('active'); if(sceneObjects.workpiece){ sceneObjects.workpiece.material.color.setHex(0x94a3b8); sceneObjects.workpiece.material.opacity=0.15;} if(sceneObjects.table){ sceneObjects.table.material.color.setHex(0x64748b);} if(sceneObjects.grid){ sceneObjects.grid.material.color.setHex(0x475569);} } }

/* =======================
   HIGHLIGHT & LINHAS
======================= */
function highlightSyntax(code){
  const lines = code.split('\n');
  return lines.map(line=>{
    let h=line;
    h = h.replace(/(;.*$|\(.*?\))/g, '<span class="hl-comment">$1</span>');
    h = h.replace(/\bG0+\b/gi, '<span class="hl-g00">$&</span>');
    h = h.replace(/\bG0*1\b/gi, '<span class="hl-g01">$&</span>');
    h = h.replace(/\bG0*[23]\b/gi, '<span class="hl-g02">$&</span>');
    h = h.replace(/\bG33\b/gi, '<span class="hl-g33">$&</span>');
    h = h.replace(/\bG76\b/gi, '<span class="hl-g76">$&</span>');
    h = h.replace(/\bG\d+/gi, (m)=>{ if(!m.match(/G(0*[0123]|33|76)\b/i)) return '<span class="hl-g-other">'+m+'</span>'; return m; });
    h = h.replace(/\bM\d+/gi, '<span class="hl-m">$&</span>');
    h = h.replace(/\b([XYZIJKRFSPQD])(?=[=\[\( -]?-?\d)/gi, '<span class="hl-letter">$1</span>');
    h = h.replace(/(?<=[XYZIJKRFSPQD]=?)-?\d+\.?\d*/gi, '<span class="hl-number">$&</span>');
    return h;
  }).join('\n');
}
function updateSyntaxHighlighting(){ const editor=document.getElementById('codeEditor'); const highlight=document.getElementById('codeHighlight'); highlight.innerHTML=highlightSyntax(editor.value); highlight.scrollTop=editor.scrollTop; }
function addLineNumbers(){ const editor=document.getElementById('codeEditor'); const inc=parseInt(document.getElementById('incrementInput').value)||10; const lines=editor.value.split('\n'); let n=inc;
  const out=lines.map(line=>{ const t=line.trim(); if(t && !t.startsWith(';') && !t.startsWith('(') && !t.match(/^N\d+/)) { const numbered='N'+n+' '+line; n+=inc; return numbered; } return line; });
  editor.value=out.join('\n'); updateLineNumbers(); updateSyntaxHighlighting(); }
function removeLineNumbers(){ const editor=document.getElementById('codeEditor'); const lines=editor.value.split('\n'); const out=lines.map(line=>line.replace(/^N\d+\s*/, '')); editor.value=out.join('\n'); updateLineNumbers(); updateSyntaxHighlighting(); }
function updateLineNumbers(){ const editor=document.getElementById('codeEditor'); const ln=document.getElementById('lineNumbers'); const lines=editor.value.split('\n');
  ln.innerHTML=lines.map((_,i)=>{ const active=(i===currentLineIndex && isRunning)?' active':''; return `<div class="line-number${active}">${i+1}</div>`; }).join(''); }

/* =======================
   PARSE & EXPRESSÕES
======================= */
function sind(a){ return Math.sin(a*Math.PI/180); }
function cosd(a){ return Math.cos(a*Math.PI/180); }
function tand(a){ return Math.tan(a*Math.PI/180); }
function evaluateExpr(expr, vars){
  let e=String(expr); e=e.replace(/\s+/g,'');
  e=e.replace(/\bLE\b/gi,'<=').replace(/\bLT\b/gi,'<').replace(/\bGE\b/gi,'>=').replace(/\bGT\b/gi,'>').replace(/\bEQ\b/gi,'==').replace(/\bNE\b/gi,'!=');
  e=e.replace(/#(\d+)/g, (_,n)=>(vars['#'+n] ?? 0));
  e=e.replace(/\bR(\d+)\b/g, (_,n)=>(vars['R'+n] ?? 0));
  e=e.replace(/\bCOS\(/gi,'cosd(').replace(/\bSIN\(/gi,'sind(').replace(/\bTAN\(/gi,'tand(');
  e=e.replace(/\[/g,'(').replace(/\]/g,')');
  try{ const f=new Function('sind','cosd','tand',`return (${e});`); return Number(f(sind,cosd,tand)); } catch(err){ console.warn('Falha evaluateExpr:', expr, '=>', e, err); return 0; }
}
function resolveWordExpressions(line, vars){
  let out=line;
  out = out.replace(/([XYZIJKRFPQD])\s*\(\s*([^()]+?)\s*\)/gi, (_,L,EX)=> `${L}${evaluateExpr(EX,vars)}`);
  out = out.replace(/([XYZIJKRFPQD])\s*\[\s*([^[\]]+?)\s*\]/gi, (_,L,EX)=> `${L}${evaluateExpr(EX,vars)}`);
  out = out.replace(/([XYZIJKRFPQD])\s*=\s*([^\s]+)/gi, (_,L,EX)=> `${L}${evaluateExpr(EX,vars)}`);
  out = out.replace(/([XYZIJKRFPQD])\s*#(\d+)/gi, (_,L,n)=> `${L}${(variables['#'+n] ?? 0)}`);
  out = out.replace(/([XYZIJKRFPQD])\s*R(\d+)/gi, (_,L,n)=> `${L}${(variables['R'+n] ?? 0)}`);
  return out;
}
function parseGCode(line){
  const words={};
  const matches = line.match(/([A-Z])-?\d+\.?\d*/gi) || [];
  matches.forEach(m=>{ const letter=m[0].toUpperCase(); const value=parseFloat(m.slice(1)); if(!isNaN(value)) words[letter]=value; });
  return words;
}
function extractWhileCond(line){
  let m=line.match(/WHILE\s*\[([^[\]]+)\]\s*DO/i); if(m) return m[1];
  m=line.match(/WHILE\s*\(([^()]+)\)\s*DO/i); if(m) return m[1];
  return null;
}

/* =======================
   ARCOS & TRAJETÓRIA
======================= */
function interpolateArc(startPos, endPos, center, isClockwise, plane, steps=20){
  const points=[]; let axis1,axis2,axis3;
  if(plane===17){ axis1='x'; axis2='y'; axis3='z'; } else if(plane===18){ axis1='z'; axis2='x'; axis3='y'; } else { axis1='y'; axis2='z'; axis3='x'; }
  const start1=startPos[axis1]-center[axis1], start2=startPos[axis2]-center[axis2], end1=endPos[axis1]-center[axis1], end2=endPos[axis2]-center[axis2];
  const startAngle=Math.atan2(start2,start1); let endAngle=Math.atan2(end2,end1);
  if(isClockwise){ while(endAngle>=startAngle) endAngle-=2*Math.PI; } else { while(endAngle<=startAngle) endAngle+=2*Math.PI; }
  const radius=Math.sqrt(start1*start1+start2*start2); const dA=(endAngle-startAngle)/steps;
  for(let i=0;i<=steps;i++){ const a=startAngle+dA*i; const p={...startPos}; p[axis1]=center[axis1]+radius*Math.cos(a); p[axis2]=center[axis2]+radius*Math.sin(a); p[axis3]=startPos[axis3]+(endPos[axis3]-startPos[axis3])*(i/steps); points.push(p); }
  return points;
}
function createToolPath(startPos, endPos, gCode){
  const points=[]; let color;
  if(gCode===0||gCode===1){ color = (gCode===0)?0xff3333:0x00ff00;
    points.push(new THREE.Vector3(startPos.x,startPos.z,startPos.y), new THREE.Vector3(endPos.x,endPos.z,endPos.y));
  } else if(gCode===2||gCode===3){ color=0x00ffff; if(Array.isArray(endPos)){ endPos.forEach(p=>points.push(new THREE.Vector3(p.x,p.z,p.y))); } else { points.push(new THREE.Vector3(startPos.x,startPos.z,startPos.y), new THREE.Vector3(endPos.x,endPos.z,endPos.y)); } }
  if(points.length<2) return null;
  const geometry=new THREE.BufferGeometry().setFromPoints(points);
  const material=new THREE.LineBasicMaterial({ color, linewidth:2, transparent:false, opacity:1 });
  const line=new THREE.Line(geometry, material); scene.add(line); toolPathLines.push(line); return line;
}

/* =======================
   EXECUÇÃO DE LINHA
======================= */
function executeLine(line){
  const words=parseGCode(line);

  // Modal G
  if(words.G!==undefined){
    const g=words.G;
    if([0,1,2,3].includes(g)) machineState.modalG.motion=g;
    else if([17,18,19].includes(g)){ machineState.modalG.plane=g; if(g===17){ document.getElementById('btnG17').classList.add('active'); document.getElementById('btnG18').classList.remove('active'); } else if(g===18){ document.getElementById('btnG18').classList.add('active'); document.getElementById('btnG17').classList.remove('active'); } }
    else if(g===90||g===91) machineState.modalG.distance=g;
    else if([40,41,42].includes(g)){ machineState.modalG.compensation=g; updateCompensationIndicator(); }
    else if(g===80) machineState.modalG.cycle=0;
    else if(g>=81 && g<=89) machineState.modalG.cycle=g;
  }

  if(words.D!==undefined){ machineState.toolRadius=words.D; updateCompensationIndicator(); }
  if(words.F!==undefined){ machineState.feedRate=words.F; document.getElementById('feedRate').textContent=words.F.toFixed(0); }
  if(words.S!==undefined){ machineState.spindleSpeed=words.S; document.getElementById('spindle').textContent=words.S.toFixed(0); }

  if(machineState.modalG.cycle>0){ executeDrillingCycle(words); updateDisplay(); return; }

  const hasMotion = ['X','Y','Z'].some(k=>words[k]!==undefined);
  if(hasMotion){
    const startPos={...machineState.position};
    const targetPos={...machineState.position};
    if(machineState.modalG.distance===90){
      if(words.X!==undefined) targetPos.x=words.X;
      if(words.Y!==undefined) targetPos.y=words.Y;
      if(words.Z!==undefined) targetPos.z=words.Z;
    } else {
      if(words.X!==undefined) targetPos.x+=words.X;
      if(words.Y!==undefined) targetPos.y+=words.Y;
      if(words.Z!==undefined) targetPos.z+=words.Z;
    }

    if([0,1].includes(machineState.modalG.motion)){
      createToolPath(startPos, targetPos, machineState.modalG.motion);
    } else if([2,3].includes(machineState.modalG.motion)){
      const center={...startPos}; const plane=machineState.modalG.plane;
      if(plane===17){ if(words.I!==undefined) center.x+=words.I; if(words.J!==undefined) center.y+=words.J; }
      else if(plane===18){ if(words.I!==undefined) center.z+=words.I; if(words.K!==undefined) center.x+=words.K; }
      else { if(words.J!==undefined) center.y+=words.J; if(words.K!==undefined) center.z+=words.K; }
      const isClockwise=(machineState.modalG.motion===2);
      const arcPoints=interpolateArc(startPos, targetPos, center, isClockwise, plane);
      createToolPath(startPos, arcPoints, machineState.modalG.motion);
    }

    machineState.position=targetPos;
    updateDisplay();
    updateToolPosition(targetPos);
  }
}

function executeDrillingCycle(words){
  const params=machineState.cycleParams;
  if(words.R!==undefined) params.R=words.R;
  if(words.Z!==undefined) params.Z=words.Z;
  if(words.Q!==undefined) params.Q=words.Q;
  if(words.F!==undefined) params.F=words.F;

  const currentPos={...machineState.position};
  const holePos={ x: words.X!==undefined?words.X:currentPos.x, y: words.Y!==undefined?words.Y:currentPos.y, z: currentPos.z };

  if(words.X!==undefined || words.Y!==undefined){
    createToolPath(currentPos, {...holePos, z:params.R}, 0);
    machineState.position={...holePos, z:params.R};
  }

  createToolPath({...holePos, z:params.R}, {...holePos, z:params.Z}, 1);
  createToolPath({...holePos, z:params.Z}, {...holePos, z:params.R}, 0);
  machineState.position={...holePos, z:params.R};
  updateToolPosition(machineState.position);
}

function updateToolPosition(pos){ if(sceneObjects.tool){ sceneObjects.tool.position.x=pos.x; sceneObjects.tool.position.z=pos.y; sceneObjects.tool.position.y=pos.z+20; } }
function updateDisplay(){ document.getElementById('posX').textContent=machineState.position.x.toFixed(2); document.getElementById('posY').textContent=machineState.position.y.toFixed(2); document.getElementById('posZ').textContent=machineState.position.z.toFixed(2); }
function updateCompensationIndicator(){ const ind=document.getElementById('compensationIndicator'); const c=machineState.modalG.compensation; if(c===40){ ind.textContent='G40'; ind.style.background='rgba(100, 100, 100, 0.9)'; ind.classList.remove('active'); } else if(c===41){ ind.textContent='G41 - R'+machineState.toolRadius+'mm'; ind.style.background='rgba(59, 130, 246, 0.9)'; ind.classList.add('active'); } else if(c===42){ ind.textContent='G42 - R'+machineState.toolRadius+'mm'; ind.style.background='rgba(239, 68, 68, 0.9)'; ind.classList.add('active'); } }

/* =======================
   SIMULAÇÃO / CONTROLE DE FLUXO
======================= */
function buildLabelIndex(lines){
  labelIndex={};
  lines.forEach((raw,i)=>{ const m=raw.trim().match(/^N(\d+)\b/); if(m){ labelIndex['N'+m[1]]=i; } });
}
function gotoLabel(label){
  const key = label.toUpperCase().startsWith('N') ? label.toUpperCase() : 'N'+label;
  if(labelIndex[key]!==undefined){ currentLineIndex = labelIndex[key]; return true; }
  return false;
}

function runSimulation(){
  isRunning=true;
  document.getElementById('runBtn').style.display='none';
  document.getElementById('pauseBtn').style.display='inline-flex';

  const code=document.getElementById('codeEditor').value;
  const lines=code.split('\n');

  // reset & indexação de labels
  flowStack.length=0;
  variables = {};
  buildLabelIndex(lines);

  simulateNextLine(lines);
}

function simulateNextLine(lines){
  if(!isRunning) return;

  // pula vazias/comentários
  while(currentLineIndex<lines.length){
    const raw=lines[currentLineIndex].trim();
    if(raw && !raw.startsWith(';') && !raw.startsWith('(')) break;
    currentLineIndex++;
  }
  if(currentLineIndex>=lines.length){ pauseSimulation(); return; }

  let line = lines[currentLineIndex];

  try{
    const trimmed = line.trim();

    // LABEL: apenas segue
    if(/^N\d+\b/.test(trimmed)){
      // não executa nada; só exibe a linha e segue
    }
    // ATRIBUIÇÕES
    else if(/^#\s*\d+\s*=/.test(trimmed)){ const m=trimmed.match(/^#\s*(\d+)\s*=\s*(.+)$/i); if(m){ variables['#'+m[1]]=evaluateExpr(m[2], variables); } }
    else if(/^R\s*\d+\s*=/.test(trimmed)){ const m=trimmed.match(/^R\s*(\d+)\s*=\s*(.+)$/i); if(m){ variables['R'+m[1]]=evaluateExpr(m[2], variables); } }
    // IF (...) GOTO Nxxxx  |  IF[...]GOTOxxxx
    else if(/^IF\b/i.test(trimmed)){
      // Siemens: IF (cond) GOTO N1000
      let m = trimmed.match(/^IF\s*\(([^)]+)\)\s*GOTO\s*(N?\d+)/i);
      if(!m){
        // Fanuc: IF[cond]GOTO1000
        m = trimmed.match(/^IF\s*\[([^[\]]+)\]\s*GOTO\s*(N?\d+)/i);
      }
      if(m){
        const condStr = m[1]; const label = m[2];
        const ok = !!evaluateExpr(condStr, variables);
        if(ok){
          // salto
          if(!gotoLabel(label)){ console.warn('Label não encontrado:', label); }
          updateLineNumbers(); document.getElementById('currentLine').textContent=currentLineIndex+1;
          setTimeout(()=>simulateNextLine(lines), simulationSpeed);
          return;
        }
      } else {
        // IF ... sem GOTO -> ignora neste MVP
      }
    }
    // GOTO Nxxxx | GOTO 1000
    else if(/^GOTO\b/i.test(trimmed)){
      const m=trimmed.match(/^GOTO\s*(N?\d+)/i);
      if(m){
        if(!gotoLabel(m[1])) console.warn('Label não encontrado:', m[1]);
        updateLineNumbers(); document.getElementById('currentLine').textContent=currentLineIndex+1;
        setTimeout(()=>simulateNextLine(lines), simulationSpeed);
        return;
      }
    }
    // WHILE
    else if(/^WHILE\b/i.test(trimmed)){
      const cond = extractWhileCond(trimmed);
      const ok = cond ? !!evaluateExpr(cond, variables) : false;
      flowStack.push({ type:'WHILE', cond, startIndex: currentLineIndex+1 });
      if(!ok){
        // pula até END
        let depth=1, i=currentLineIndex+1;
        while(i<lines.length && depth>0){
          const s=lines[i].trim();
          if(/^WHILE\b/i.test(s)) depth++;
          if(/^(END1|ENDWHILE)\b/i.test(s)) depth--;
          i++;
        }
        currentLineIndex=i;
        updateLineNumbers(); document.getElementById('currentLine').textContent=currentLineIndex+1;
        setTimeout(()=>simulateNextLine(lines), simulationSpeed);
        return;
      }
    }
    // END1 / ENDWHILE
    else if(/^(END1|ENDWHILE)\b/i.test(trimmed)){
      for(let i=flowStack.length-1;i>=0;i--){
        if(flowStack[i].type==='WHILE'){
          const cond=flowStack[i].cond; const ok=cond?!!evaluateExpr(cond, variables):false;
          if(ok){ currentLineIndex=flowStack[i].startIndex; } else { flowStack.splice(i,1); }
          updateLineNumbers(); document.getElementById('currentLine').textContent=currentLineIndex+1;
          setTimeout(()=>simulateNextLine(lines), simulationSpeed);
          return;
        }
      }
    }
    // MOVIMENTOS / G-CODES
    else {
      let execLine = resolveWordExpressions(trimmed, variables);
      execLine = execLine.replace(/#(\d+)/g, (_,n)=>(variables['#'+n] ?? 0));
      execLine = execLine.replace(/\bR(\d+)\b/g, (_,n)=>(variables['R'+n] ?? 0));
      executeLine(execLine);
    }

  } catch(err){ console.error('Erro:', line, err); }

  updateLineNumbers();
  document.getElementById('currentLine').textContent=currentLineIndex+1;
  currentLineIndex++;
  setTimeout(()=>simulateNextLine(lines), simulationSpeed);
}

function pauseSimulation(){ isRunning=false; document.getElementById('runBtn').style.display='inline-flex'; document.getElementById('pauseBtn').style.display='none'; }
function stepSimulation(){
  const code=document.getElementById('codeEditor').value;
  const lines=code.split('\n');

  // se for o 1º passo, indexa labels
  if(currentLineIndex===0) buildLabelIndex(lines);

  while(currentLineIndex<lines.length){
    const raw=lines[currentLineIndex].trim();
    if(raw && !raw.startsWith(';') && !raw.startsWith('(')) break;
    currentLineIndex++;
  }
  if(currentLineIndex>=lines.length) return;

  let line=lines[currentLineIndex];
  try{ executeLine(resolveWordExpressions(line, variables)); } catch(err){ console.error('Erro:', line, err); }
  updateLineNumbers();
  document.getElementById('currentLine').textContent=currentLineIndex+1;
  currentLineIndex++;
}

function updateSpeed(value){ simulationSpeed=510-parseInt(value); document.getElementById('speedDisplay').textContent=simulationSpeed+'ms'; }
function resetSimulation(){
  pauseSimulation(); currentLineIndex=0; variables={}; flowStack.length=0; labelIndex={};
  machineState.position={x:0,y:0,z:0}; machineState.modalG={motion:0, plane:17, distance:90, compensation:40, cycle:0};
  machineState.feedRate=0; machineState.spindleSpeed=0; machineState.toolRadius=5;
  document.getElementById('btnG17').classList.add('active'); document.getElementById('btnG18').classList.remove('active');
  document.getElementById('posX').textContent='0.00'; document.getElementById('posY').textContent='0.00'; document.getElementById('posZ').textContent='0.00';
  document.getElementById('spindle').textContent='0'; document.getElementById('feedRate').textContent='0'; document.getElementById('currentLine').textContent='0';
  updateLineNumbers(); updateCompensationIndicator();
  toolPathLines.forEach(line=>scene.remove(line)); toolPathLines=[];
  if(sceneObjects.tool){ sceneObjects.tool.position.set(0,30,0); }
  document.getElementById('speedSlider').value=100; updateSpeed(100);
}

/* =======================
   DIALETO & EXEMPLOS
======================= */
function setDialect(dialect){
  currentDialect=dialect; document.getElementById('dialectDisplay').textContent=dialect;
  document.querySelectorAll('.btn-dialect').forEach(btn=>{ btn.classList.remove('active'); if(btn.dataset.dialect===dialect) btn.classList.add('active'); });
}
function openExamples(){
  const modal=document.getElementById('examplesModal'); const content=document.getElementById('examplesContent');
  let html='';
  Object.entries(examples).forEach(([dialect, exs])=>{
    html += `<h3 style="color: var(--primary); margin: 1.5rem 0 1rem 0;">${dialect}</h3><div class="examples-grid">`;
    exs.forEach((ex,idx)=>{ html+=`<div class="example-card" onclick="loadExample('${dialect}', ${idx})"><div class="example-category">${ex.category}</div><div class="example-title">${ex.name}</div><div class="example-desc">${ex.description}</div></div>`; });
    html += '</div>';
  });
  content.innerHTML=html; modal.classList.add('active');
}
function loadExample(dialect, index){
  const example=examples[dialect][index];
  if(example){ document.getElementById('codeEditor').value=example.code; document.getElementById('programName').value=example.name; setDialect(dialect); updateLineNumbers(); updateSyntaxHighlighting(); closeModal('examplesModal'); resetSimulation(); }
}

/* =======================
   MODAIS / UTIL
======================= */
function openCodeRef(){
  const modal=document.getElementById('codeRefModal'); const content=document.getElementById('codeRefContent');
  content.innerHTML=`
    <div class="code-reference"><div class="code-ref-title">Códigos G:</div>
      <div class="code-ref-desc">
        <strong style="color:#ff0000;">G00</strong> - Rápido<br>
        <strong style="color:#00ff00;">G01</strong> - Linear<br>
        <strong style="color:#00bfff;">G02/G03</strong> - Arcos<br>
        <strong style="color: var(--gold);">G04</strong> - Pausa<br>
        <strong style="color: var(--purple);">G17/G18/G19</strong> - Planos<br>
        <strong style="color: var(--green);">G54-G59</strong> - Offsets<br>
        <strong style="color: var(--secondary);">G90/G91</strong> - Abs/Inc
      </div>
    </div>
    <div class="code-reference"><div class="code-ref-title">Compensação:</div>
      <div class="code-ref-desc"><strong>G40</strong> Cancelar · <strong>G41</strong> Esq (D) · <strong>G42</strong> Dir (D)</div>
    </div>
    <div class="code-reference"><div class="code-ref-title">Ciclos Fixos:</div>
      <div class="code-ref-desc"><strong>G81</strong> Furação · <strong>G83</strong> Profunda (Q) · <strong>G80</strong> Cancela<br><br>
      <strong>R</strong> Plano retorno · <strong>Z</strong> Profundidade · <strong>Q</strong> Incremento</div>
    </div>`;
  modal.classList.add('active');
}
function openVariables(){
  const modal=document.getElementById('variablesModal'); const content=document.getElementById('variablesContent');
  if(Object.keys(variables).length===0){
    content.innerHTML='<p style="text-align: center; color: var(--text-light); padding: 2rem;">Execute um programa paramétrico.</p>';
  } else {
    let html='<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:1rem;">';
    Object.entries(variables).forEach(([k,v])=>{
      const val=(typeof v==='number' && isFinite(v))? v.toFixed(3): String(v);
      html+=`<div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 10px; text-align: center; border: 2px solid rgba(139, 92, 246, 0.3);">
        <div style="color: var(--purple); font-weight: bold; margin-bottom: 0.5rem; font-family: 'Courier New', monospace;">${k}</div>
        <div style="color: var(--primary); font-size: 1.3rem; font-weight: bold;">${val}</div></div>`;
    }); html+='</div>'; content.innerHTML=html;
  }
  modal.classList.add('active');
}
function closeModal(id){ document.getElementById(id).classList.remove('active'); }
function newProgram(){
  if(document.getElementById('codeEditor').value.trim()!==''){ if(!confirm('Criar novo programa? O atual será perdido se não foi salvo.')) return; }
  document.getElementById('codeEditor').value='; Novo Programa\nG54 G90 G21 G17\nM03 S1500\n\n\n\nM05\nM30';
  document.getElementById('programName').value='Novo Programa';
  updateLineNumbers(); updateSyntaxHighlighting(); resetSimulation();
}
function downloadProgram(){
  const code=document.getElementById('codeEditor').value; const name=document.getElementById('programName').value;
  const blob=new Blob([code], {type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`${name.replace(/\s+/g,'_')}.nc`; a.click(); URL.revokeObjectURL(url);
}
function uploadFile(event){
  const file=event.target.files[0]; if(file){ const reader=new FileReader();
    reader.onload=(e)=>{ document.getElementById('codeEditor').value=e.target.result; document.getElementById('programName').value=file.name.replace(/\.(nc|txt|gcode)$/,''); updateLineNumbers(); updateSyntaxHighlighting(); resetSimulation(); };
    reader.readAsText(file);
  }
}
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key==='s'){ e.preventDefault(); downloadProgram(); }
  else if(e.key==='F5'){ e.preventDefault(); runSimulation(); }
  else if(e.key==='Escape'){ if(isRunning) pauseSimulation(); document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); }
  else if(e.key==='1' && !e.ctrlKey && !e.altKey){ const editor=document.getElementById('codeEditor'); if(document.activeElement!==editor) setPlane(17); }
  else if(e.key==='2' && !e.ctrlKey && !e.altKey){ const editor=document.getElementById('codeEditor'); if(document.activeElement!==editor) setPlane(18); }
});
</script>
</body>
</html>
